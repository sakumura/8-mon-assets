name: Generate Radio Audio

on:
  schedule:
    # JST = UTC+9
    # 稼働時間: 7:00 JST〜23:00 JST（1時間間隔、深夜なし）
    # UTC 22:00 = JST 07:00
    # UTC 14:00 = JST 23:00
    - cron: "0 22-23 * * 0-4"   # JST 07:00-08:00 (日〜木の夜 = 月〜金の朝)
    - cron: "0 0-14 * * 1-5"    # JST 09:00-23:00 (月〜金)
  workflow_dispatch:  # 手動実行

jobs:
  generate:
    runs-on: ubuntu-latest
    services:
      voicevox:
        image: voicevox/voicevox_engine:cpu-ubuntu20.04-latest
        ports:
          - 50021:50021

    steps:
      - name: Free up disk space
        run: |
          # 不要なツールを削除してディスク容量を確保
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          df -h

      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install requests pydub numpy boto3 beautifulsoup4 lxml

      - name: Wait for VOICEVOX
        run: |
          echo "Waiting for VOICEVOX engine..."
          for i in {1..30}; do
            if curl -s http://localhost:50021/version > /dev/null; then
              echo "VOICEVOX is ready!"
              curl -s http://localhost:50021/version
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Generate audio
        env:
          GARYU_API_KEY: ${{ secrets.GARYU_API_KEY }}
        run: |
          mkdir -p output
          python radio/generate_radio_audio.py --output-dir output

      - name: Upload to R2
        env:
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: python scripts/upload_to_r2.py audio output
